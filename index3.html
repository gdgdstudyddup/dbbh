<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=1000">
    <title>Web GPU Cube demo</title>
    <script src="assets/bunny2.js"></script>
    <script src="gl-matrix.js"></script>
</head>

<body>
    <canvas height=1000 width=1000></canvas>
    <script>
        const positionAttributeNum = 0;
        const colorAttributeNum = 1;
        const transformBindingNum = 0;
        const bindGroupIndex = 0;
        const colorLocation = 0;

        const shader = `
struct FragmentData {
    @builtin(position) position: vec4<f32>,
};
struct Uniforms {
    modelViewProjectionMatrix: mat4x4<f32>
};
@group(${bindGroupIndex}) @binding(${transformBindingNum}) var<uniform> uniforms: Uniforms;
@vertex
fn vertex_main(
    @builtin(instance_index) instanceIdx : u32,
    @builtin(vertex_index) VertexIndex : u32,
    @location(${positionAttributeNum}) position: vec3<f32>,
) -> FragmentData {
    var outData: FragmentData;
    outData.position = uniforms.modelViewProjectionMatrix *  vec4<f32>(position.xyz, 1.0);
    //if(instanceIdx==0){outData.color = vec4<f32>(1.0,0.0,0.0,1.0);}
    return outData;
}
@fragment
fn fragment_main(data: FragmentData) -> @location(0) vec4<f32> {
    return vec4<f32>(data.position.xy*0.002,1.0, 1.0);
}
`;
        let cubeDraw, cubeBuffer, gpu, renderer;
        let device, context, verticesBuffer, indicesBuffer, renderPipeline, renderPassDescriptor;
        let transformBuffer, bindGroup;
        const projectionMatrix = mat4.create();
        const mappedGroups = [];
        const test2 = {
            pos: [
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                0,
                1,
                0,
                -0.30901700258255005,
                0.9510565400123596,
                0,
                -0.29389262199401855,
                0.9510565400123596,
                0.09549150615930557,
                -0.25,
                0.9510565400123596,
                0.18163563311100006,
                -0.18163563311100006,
                0.9510565400123596,
                0.25,
                -0.09549150615930557,
                0.9510565400123596,
                0.29389262199401855,
                -1.8921834267128088e-17,
                0.9510565400123596,
                0.30901700258255005,
                0.09549150615930557,
                0.9510565400123596,
                0.29389262199401855,
                0.18163563311100006,
                0.9510565400123596,
                0.25,
                0.25,
                0.9510565400123596,
                0.18163563311100006,
                0.29389262199401855,
                0.9510565400123596,
                0.09549150615930557,
                0.30901700258255005,
                0.9510565400123596,
                3.7843668534256176e-17,
                0.29389262199401855,
                0.9510565400123596,
                -0.09549150615930557,
                0.25,
                0.9510565400123596,
                -0.18163563311100006,
                0.18163563311100006,
                0.9510565400123596,
                -0.25,
                0.09549150615930557,
                0.9510565400123596,
                -0.29389262199401855,
                5.676550114702304e-17,
                0.9510565400123596,
                -0.30901700258255005,
                -0.09549150615930557,
                0.9510565400123596,
                -0.29389262199401855,
                -0.18163563311100006,
                0.9510565400123596,
                -0.25,
                -0.25,
                0.9510565400123596,
                -0.18163563311100006,
                -0.29389262199401855,
                0.9510565400123596,
                -0.09549150615930557,
                -0.30901700258255005,
                0.9510565400123596,
                -7.568733706851235e-17,
                -0.5877852439880371,
                0.80901700258255,
                0,
                -0.55901700258255,
                0.80901700258255,
                0.18163563311100006,
                -0.4755282700061798,
                0.80901700258255,
                0.345491498708725,
                -0.345491498708725,
                0.80901700258255,
                0.4755282700061798,
                -0.18163563311100006,
                0.80901700258255,
                0.55901700258255,
                -3.599146555896214e-17,
                0.80901700258255,
                0.5877852439880371,
                0.18163563311100006,
                0.80901700258255,
                0.55901700258255,
                0.345491498708725,
                0.80901700258255,
                0.4755282700061798,
                0.4755282700061798,
                0.80901700258255,
                0.345491498708725,
                0.55901700258255,
                0.80901700258255,
                0.18163563311100006,
                0.5877852439880371,
                0.80901700258255,
                7.198293111792428e-17,
                0.55901700258255,
                0.80901700258255,
                -0.18163563311100006,
                0.4755282700061798,
                0.80901700258255,
                -0.345491498708725,
                0.345491498708725,
                0.80901700258255,
                -0.4755282700061798,
                0.18163563311100006,
                0.80901700258255,
                -0.55901700258255,
                1.0797439998560886e-16,
                0.80901700258255,
                -0.5877852439880371,
                -0.18163563311100006,
                0.80901700258255,
                -0.55901700258255,
                -0.345491498708725,
                0.80901700258255,
                -0.4755282700061798,
                -0.4755282700061798,
                0.80901700258255,
                -0.345491498708725,
                -0.55901700258255,
                0.80901700258255,
                -0.18163563311100006,
                -0.5877852439880371,
                0.80901700258255,
                -1.4396586223584855e-16,
                -0.80901700258255,
                0.5877852439880371,
                0,
                -0.769420862197876,
                0.5877852439880371,
                0.25,
                -0.6545084714889526,
                0.5877852439880371,
                0.4755282700061798,
                -0.4755282700061798,
                0.5877852439880371,
                0.6545084714889526,
                -0.25,
                0.5877852439880371,
                0.769420862197876,
                -4.953800392739606e-17,
                0.5877852439880371,
                0.80901700258255,
                0.25,
                0.5877852439880371,
                0.769420862197876,
                0.4755282700061798,
                0.5877852439880371,
                0.6545084714889526,
                0.6545084714889526,
                0.5877852439880371,
                0.4755282700061798,
                0.769420862197876,
                0.5877852439880371,
                0.25,
                0.80901700258255,
                0.5877852439880371,
                9.907600785479212e-17,
                0.769420862197876,
                0.5877852439880371,
                -0.25,
                0.6545084714889526,
                0.5877852439880371,
                -0.4755282700061798,
                0.4755282700061798,
                0.5877852439880371,
                -0.6545084714889526,
                0.25,
                0.5877852439880371,
                -0.769420862197876,
                1.4861400847346573e-16,
                0.5877852439880371,
                -0.80901700258255,
                -0.25,
                0.5877852439880371,
                -0.769420862197876,
                -0.4755282700061798,
                0.5877852439880371,
                -0.6545084714889526,
                -0.6545084714889526,
                0.5877852439880371,
                -0.4755282700061798,
                -0.769420862197876,
                0.5877852439880371,
                -0.25,
                -0.80901700258255,
                0.5877852439880371,
                -1.9815201570958424e-16,
                -0.9510565400123596,
                0.30901700258255005,
                0,
                -0.9045084714889526,
                0.30901700258255005,
                0.29389262199401855,
                -0.769420862197876,
                0.30901700258255005,
                0.55901700258255,
                -0.55901700258255,
                0.30901700258255005,
                0.769420862197876,
                -0.29389262199401855,
                0.30901700258255005,
                0.9045084714889526,
                -5.823541433041957e-17,
                0.30901700258255005,
                0.9510565400123596,
                0.29389262199401855,
                0.30901700258255005,
                0.9045084714889526,
                0.55901700258255,
                0.30901700258255005,
                0.769420862197876,
                0.769420862197876,
                0.30901700258255005,
                0.55901700258255,
                0.9045084714889526,
                0.30901700258255005,
                0.29389262199401855,
                0.9510565400123596,
                0.30901700258255005,
                1.1647082866083914e-16,
                0.9045084714889526,
                0.30901700258255005,
                -0.29389262199401855,
                0.769420862197876,
                0.30901700258255005,
                -0.55901700258255,
                0.55901700258255,
                0.30901700258255005,
                -0.769420862197876,
                0.29389262199401855,
                0.30901700258255005,
                -0.9045084714889526,
                1.747062496087036e-16,
                0.30901700258255005,
                -0.9510565400123596,
                -0.29389262199401855,
                0.30901700258255005,
                -0.9045084714889526,
                -0.55901700258255,
                0.30901700258255005,
                -0.769420862197876,
                -0.769420862197876,
                0.30901700258255005,
                -0.55901700258255,
                -0.9045084714889526,
                0.30901700258255005,
                -0.29389262199401855,
                -0.9510565400123596,
                0.30901700258255005,
                -2.329416573216783e-16,
                -1,
                6.123234262925839e-17,
                0,
                -0.9510565400123596,
                6.123234262925839e-17,
                0.30901700258255005,
                -0.80901700258255,
                6.123234262925839e-17,
                0.5877852439880371,
                -0.5877852439880371,
                6.123234262925839e-17,
                0.80901700258255,
                -0.30901700258255005,
                6.123234262925839e-17,
                0.9510565400123596,
                -6.123234262925839e-17,
                6.123234262925839e-17,
                1,
                0.30901700258255005,
                6.123234262925839e-17,
                0.9510565400123596,
                0.5877852439880371,
                6.123234262925839e-17,
                0.80901700258255,
                0.80901700258255,
                6.123234262925839e-17,
                0.5877852439880371,
                0.9510565400123596,
                6.123234262925839e-17,
                0.30901700258255005,
                1,
                6.123234262925839e-17,
                1.2246468525851679e-16,
                0.9510565400123596,
                6.123234262925839e-17,
                -0.30901700258255005,
                0.80901700258255,
                6.123234262925839e-17,
                -0.5877852439880371,
                0.5877852439880371,
                6.123234262925839e-17,
                -0.80901700258255,
                0.30901700258255005,
                6.123234262925839e-17,
                -0.9510565400123596,
                1.8369701465288538e-16,
                6.123234262925839e-17,
                -1,
                -0.30901700258255005,
                6.123234262925839e-17,
                -0.9510565400123596,
                -0.5877852439880371,
                6.123234262925839e-17,
                -0.80901700258255,
                -0.80901700258255,
                6.123234262925839e-17,
                -0.5877852439880371,
                -0.9510565400123596,
                6.123234262925839e-17,
                -0.30901700258255005,
                -1,
                6.123234262925839e-17,
                -2.4492937051703357e-16,
                -0.9510565400123596,
                -0.30901700258255005,
                0,
                -0.9045084714889526,
                -0.30901700258255005,
                0.29389262199401855,
                -0.769420862197876,
                -0.30901700258255005,
                0.55901700258255,
                -0.55901700258255,
                -0.30901700258255005,
                0.769420862197876,
                -0.29389262199401855,
                -0.30901700258255005,
                0.9045084714889526,
                -5.823541433041957e-17,
                -0.30901700258255005,
                0.9510565400123596,
                0.29389262199401855,
                -0.30901700258255005,
                0.9045084714889526,
                0.55901700258255,
                -0.30901700258255005,
                0.769420862197876,
                0.769420862197876,
                -0.30901700258255005,
                0.55901700258255,
                0.9045084714889526,
                -0.30901700258255005,
                0.29389262199401855,
                0.9510565400123596,
                -0.30901700258255005,
                1.1647082866083914e-16,
                0.9045084714889526,
                -0.30901700258255005,
                -0.29389262199401855,
                0.769420862197876,
                -0.30901700258255005,
                -0.55901700258255,
                0.55901700258255,
                -0.30901700258255005,
                -0.769420862197876,
                0.29389262199401855,
                -0.30901700258255005,
                -0.9045084714889526,
                1.747062496087036e-16,
                -0.30901700258255005,
                -0.9510565400123596,
                -0.29389262199401855,
                -0.30901700258255005,
                -0.9045084714889526,
                -0.55901700258255,
                -0.30901700258255005,
                -0.769420862197876,
                -0.769420862197876,
                -0.30901700258255005,
                -0.55901700258255,
                -0.9045084714889526,
                -0.30901700258255005,
                -0.29389262199401855,
                -0.9510565400123596,
                -0.30901700258255005,
                -2.329416573216783e-16,
                -0.80901700258255,
                -0.5877852439880371,
                0,
                -0.769420862197876,
                -0.5877852439880371,
                0.25,
                -0.6545084714889526,
                -0.5877852439880371,
                0.4755282700061798,
                -0.4755282700061798,
                -0.5877852439880371,
                0.6545084714889526,
                -0.25,
                -0.5877852439880371,
                0.769420862197876,
                -4.953800392739606e-17,
                -0.5877852439880371,
                0.80901700258255,
                0.25,
                -0.5877852439880371,
                0.769420862197876,
                0.4755282700061798,
                -0.5877852439880371,
                0.6545084714889526,
                0.6545084714889526,
                -0.5877852439880371,
                0.4755282700061798,
                0.769420862197876,
                -0.5877852439880371,
                0.25,
                0.80901700258255,
                -0.5877852439880371,
                9.907600785479212e-17,
                0.769420862197876,
                -0.5877852439880371,
                -0.25,
                0.6545084714889526,
                -0.5877852439880371,
                -0.4755282700061798,
                0.4755282700061798,
                -0.5877852439880371,
                -0.6545084714889526,
                0.25,
                -0.5877852439880371,
                -0.769420862197876,
                1.4861400847346573e-16,
                -0.5877852439880371,
                -0.80901700258255,
                -0.25,
                -0.5877852439880371,
                -0.769420862197876,
                -0.4755282700061798,
                -0.5877852439880371,
                -0.6545084714889526,
                -0.6545084714889526,
                -0.5877852439880371,
                -0.4755282700061798,
                -0.769420862197876,
                -0.5877852439880371,
                -0.25,
                -0.80901700258255,
                -0.5877852439880371,
                -1.9815201570958424e-16,
                -0.5877852439880371,
                -0.80901700258255,
                0,
                -0.55901700258255,
                -0.80901700258255,
                0.18163563311100006,
                -0.4755282700061798,
                -0.80901700258255,
                0.345491498708725,
                -0.345491498708725,
                -0.80901700258255,
                0.4755282700061798,
                -0.18163563311100006,
                -0.80901700258255,
                0.55901700258255,
                -3.599146555896214e-17,
                -0.80901700258255,
                0.5877852439880371,
                0.18163563311100006,
                -0.80901700258255,
                0.55901700258255,
                0.345491498708725,
                -0.80901700258255,
                0.4755282700061798,
                0.4755282700061798,
                -0.80901700258255,
                0.345491498708725,
                0.55901700258255,
                -0.80901700258255,
                0.18163563311100006,
                0.5877852439880371,
                -0.80901700258255,
                7.198293111792428e-17,
                0.55901700258255,
                -0.80901700258255,
                -0.18163563311100006,
                0.4755282700061798,
                -0.80901700258255,
                -0.345491498708725,
                0.345491498708725,
                -0.80901700258255,
                -0.4755282700061798,
                0.18163563311100006,
                -0.80901700258255,
                -0.55901700258255,
                1.0797439998560886e-16,
                -0.80901700258255,
                -0.5877852439880371,
                -0.18163563311100006,
                -0.80901700258255,
                -0.55901700258255,
                -0.345491498708725,
                -0.80901700258255,
                -0.4755282700061798,
                -0.4755282700061798,
                -0.80901700258255,
                -0.345491498708725,
                -0.55901700258255,
                -0.80901700258255,
                -0.18163563311100006,
                -0.5877852439880371,
                -0.80901700258255,
                -1.4396586223584855e-16,
                -0.30901700258255005,
                -0.9510565400123596,
                0,
                -0.29389262199401855,
                -0.9510565400123596,
                0.09549150615930557,
                -0.25,
                -0.9510565400123596,
                0.18163563311100006,
                -0.18163563311100006,
                -0.9510565400123596,
                0.25,
                -0.09549150615930557,
                -0.9510565400123596,
                0.29389262199401855,
                -1.8921834267128088e-17,
                -0.9510565400123596,
                0.30901700258255005,
                0.09549150615930557,
                -0.9510565400123596,
                0.29389262199401855,
                0.18163563311100006,
                -0.9510565400123596,
                0.25,
                0.25,
                -0.9510565400123596,
                0.18163563311100006,
                0.29389262199401855,
                -0.9510565400123596,
                0.09549150615930557,
                0.30901700258255005,
                -0.9510565400123596,
                3.7843668534256176e-17,
                0.29389262199401855,
                -0.9510565400123596,
                -0.09549150615930557,
                0.25,
                -0.9510565400123596,
                -0.18163563311100006,
                0.18163563311100006,
                -0.9510565400123596,
                -0.25,
                0.09549150615930557,
                -0.9510565400123596,
                -0.29389262199401855,
                5.676550114702304e-17,
                -0.9510565400123596,
                -0.30901700258255005,
                -0.09549150615930557,
                -0.9510565400123596,
                -0.29389262199401855,
                -0.18163563311100006,
                -0.9510565400123596,
                -0.25,
                -0.25,
                -0.9510565400123596,
                -0.18163563311100006,
                -0.29389262199401855,
                -0.9510565400123596,
                -0.09549150615930557,
                -0.30901700258255005,
                -0.9510565400123596,
                -7.568733706851235e-17,
                -1.2246468525851679e-16,
                -1,
                0,
                -1.1647082866083914e-16,
                -1,
                3.7843668534256176e-17,
                -9.907600785479212e-17,
                -1,
                7.198293111792428e-17,
                -7.198293111792428e-17,
                -1,
                9.907600785479212e-17,
                -3.7843668534256176e-17,
                -1,
                1.1647082866083914e-16,
                -7.498798786105971e-33,
                -1,
                1.2246468525851679e-16,
                3.7843668534256176e-17,
                -1,
                1.1647082866083914e-16,
                7.198293111792428e-17,
                -1,
                9.907600785479212e-17,
                9.907600785479212e-17,
                -1,
                7.198293111792428e-17,
                1.1647082866083914e-16,
                -1,
                3.7843668534256176e-17,
                1.2246468525851679e-16,
                -1,
                1.4997597572211942e-32,
                1.1647082866083914e-16,
                -1,
                -3.7843668534256176e-17,
                9.907600785479212e-17,
                -1,
                -7.198293111792428e-17,
                7.198293111792428e-17,
                -1,
                -9.907600785479212e-17,
                3.7843668534256176e-17,
                -1,
                -1.1647082866083914e-16,
                2.2496396358317913e-32,
                -1,
                -1.2246468525851679e-16,
                -3.7843668534256176e-17,
                -1,
                -1.1647082866083914e-16,
                -7.198293111792428e-17,
                -1,
                -9.907600785479212e-17,
                -9.907600785479212e-17,
                -1,
                -7.198293111792428e-17,
                -1.1647082866083914e-16,
                -1,
                -3.7843668534256176e-17,
                -1.2246468525851679e-16,
                -1,
                -2.9995195144423884e-32
            ]
            , index: [
                0,
                21,
                22,
                1,
                22,
                23,
                2,
                23,
                24,
                3,
                24,
                25,
                4,
                25,
                26,
                5,
                26,
                27,
                6,
                27,
                28,
                7,
                28,
                29,
                8,
                29,
                30,
                9,
                30,
                31,
                10,
                31,
                32,
                11,
                32,
                33,
                12,
                33,
                34,
                13,
                34,
                35,
                14,
                35,
                36,
                15,
                36,
                37,
                16,
                37,
                38,
                17,
                38,
                39,
                18,
                39,
                40,
                19,
                40,
                41,
                22,
                21,
                43,
                21,
                42,
                43,
                23,
                22,
                44,
                22,
                43,
                44,
                24,
                23,
                45,
                23,
                44,
                45,
                25,
                24,
                46,
                24,
                45,
                46,
                26,
                25,
                47,
                25,
                46,
                47,
                27,
                26,
                48,
                26,
                47,
                48,
                28,
                27,
                49,
                27,
                48,
                49,
                29,
                28,
                50,
                28,
                49,
                50,
                30,
                29,
                51,
                29,
                50,
                51,
                31,
                30,
                52,
                30,
                51,
                52,
                32,
                31,
                53,
                31,
                52,
                53,
                33,
                32,
                54,
                32,
                53,
                54,
                34,
                33,
                55,
                33,
                54,
                55,
                35,
                34,
                56,
                34,
                55,
                56,
                36,
                35,
                57,
                35,
                56,
                57,
                37,
                36,
                58,
                36,
                57,
                58,
                38,
                37,
                59,
                37,
                58,
                59,
                39,
                38,
                60,
                38,
                59,
                60,
                40,
                39,
                61,
                39,
                60,
                61,
                41,
                40,
                62,
                40,
                61,
                62,
                43,
                42,
                64,
                42,
                63,
                64,
                44,
                43,
                65,
                43,
                64,
                65,
                45,
                44,
                66,
                44,
                65,
                66,
                46,
                45,
                67,
                45,
                66,
                67,
                47,
                46,
                68,
                46,
                67,
                68,
                48,
                47,
                69,
                47,
                68,
                69,
                49,
                48,
                70,
                48,
                69,
                70,
                50,
                49,
                71,
                49,
                70,
                71,
                51,
                50,
                72,
                50,
                71,
                72,
                52,
                51,
                73,
                51,
                72,
                73,
                53,
                52,
                74,
                52,
                73,
                74,
                54,
                53,
                75,
                53,
                74,
                75,
                55,
                54,
                76,
                54,
                75,
                76,
                56,
                55,
                77,
                55,
                76,
                77,
                57,
                56,
                78,
                56,
                77,
                78,
                58,
                57,
                79,
                57,
                78,
                79,
                59,
                58,
                80,
                58,
                79,
                80,
                60,
                59,
                81,
                59,
                80,
                81,
                61,
                60,
                82,
                60,
                81,
                82,
                62,
                61,
                83,
                61,
                82,
                83,
                64,
                63,
                85,
                63,
                84,
                85,
                65,
                64,
                86,
                64,
                85,
                86,
                66,
                65,
                87,
                65,
                86,
                87,
                67,
                66,
                88,
                66,
                87,
                88,
                68,
                67,
                89,
                67,
                88,
                89,
                69,
                68,
                90,
                68,
                89,
                90,
                70,
                69,
                91,
                69,
                90,
                91,
                71,
                70,
                92,
                70,
                91,
                92,
                72,
                71,
                93,
                71,
                92,
                93,
                73,
                72,
                94,
                72,
                93,
                94,
                74,
                73,
                95,
                73,
                94,
                95,
                75,
                74,
                96,
                74,
                95,
                96,
                76,
                75,
                97,
                75,
                96,
                97,
                77,
                76,
                98,
                76,
                97,
                98,
                78,
                77,
                99,
                77,
                98,
                99,
                79,
                78,
                100,
                78,
                99,
                100,
                80,
                79,
                101,
                79,
                100,
                101,
                81,
                80,
                102,
                80,
                101,
                102,
                82,
                81,
                103,
                81,
                102,
                103,
                83,
                82,
                104,
                82,
                103,
                104,
                85,
                84,
                106,
                84,
                105,
                106,
                86,
                85,
                107,
                85,
                106,
                107,
                87,
                86,
                108,
                86,
                107,
                108,
                88,
                87,
                109,
                87,
                108,
                109,
                89,
                88,
                110,
                88,
                109,
                110,
                90,
                89,
                111,
                89,
                110,
                111,
                91,
                90,
                112,
                90,
                111,
                112,
                92,
                91,
                113,
                91,
                112,
                113,
                93,
                92,
                114,
                92,
                113,
                114,
                94,
                93,
                115,
                93,
                114,
                115,
                95,
                94,
                116,
                94,
                115,
                116,
                96,
                95,
                117,
                95,
                116,
                117,
                97,
                96,
                118,
                96,
                117,
                118,
                98,
                97,
                119,
                97,
                118,
                119,
                99,
                98,
                120,
                98,
                119,
                120,
                100,
                99,
                121,
                99,
                120,
                121,
                101,
                100,
                122,
                100,
                121,
                122,
                102,
                101,
                123,
                101,
                122,
                123,
                103,
                102,
                124,
                102,
                123,
                124,
                104,
                103,
                125,
                103,
                124,
                125,
                106,
                105,
                127,
                105,
                126,
                127,
                107,
                106,
                128,
                106,
                127,
                128,
                108,
                107,
                129,
                107,
                128,
                129,
                109,
                108,
                130,
                108,
                129,
                130,
                110,
                109,
                131,
                109,
                130,
                131,
                111,
                110,
                132,
                110,
                131,
                132,
                112,
                111,
                133,
                111,
                132,
                133,
                113,
                112,
                134,
                112,
                133,
                134,
                114,
                113,
                135,
                113,
                134,
                135,
                115,
                114,
                136,
                114,
                135,
                136,
                116,
                115,
                137,
                115,
                136,
                137,
                117,
                116,
                138,
                116,
                137,
                138,
                118,
                117,
                139,
                117,
                138,
                139,
                119,
                118,
                140,
                118,
                139,
                140,
                120,
                119,
                141,
                119,
                140,
                141,
                121,
                120,
                142,
                120,
                141,
                142,
                122,
                121,
                143,
                121,
                142,
                143,
                123,
                122,
                144,
                122,
                143,
                144,
                124,
                123,
                145,
                123,
                144,
                145,
                125,
                124,
                146,
                124,
                145,
                146,
                127,
                126,
                148,
                126,
                147,
                148,
                128,
                127,
                149,
                127,
                148,
                149,
                129,
                128,
                150,
                128,
                149,
                150,
                130,
                129,
                151,
                129,
                150,
                151,
                131,
                130,
                152,
                130,
                151,
                152,
                132,
                131,
                153,
                131,
                152,
                153,
                133,
                132,
                154,
                132,
                153,
                154,
                134,
                133,
                155,
                133,
                154,
                155,
                135,
                134,
                156,
                134,
                155,
                156,
                136,
                135,
                157,
                135,
                156,
                157,
                137,
                136,
                158,
                136,
                157,
                158,
                138,
                137,
                159,
                137,
                158,
                159,
                139,
                138,
                160,
                138,
                159,
                160,
                140,
                139,
                161,
                139,
                160,
                161,
                141,
                140,
                162,
                140,
                161,
                162,
                142,
                141,
                163,
                141,
                162,
                163,
                143,
                142,
                164,
                142,
                163,
                164,
                144,
                143,
                165,
                143,
                164,
                165,
                145,
                144,
                166,
                144,
                165,
                166,
                146,
                145,
                167,
                145,
                166,
                167,
                148,
                147,
                169,
                147,
                168,
                169,
                149,
                148,
                170,
                148,
                169,
                170,
                150,
                149,
                171,
                149,
                170,
                171,
                151,
                150,
                172,
                150,
                171,
                172,
                152,
                151,
                173,
                151,
                172,
                173,
                153,
                152,
                174,
                152,
                173,
                174,
                154,
                153,
                175,
                153,
                174,
                175,
                155,
                154,
                176,
                154,
                175,
                176,
                156,
                155,
                177,
                155,
                176,
                177,
                157,
                156,
                178,
                156,
                177,
                178,
                158,
                157,
                179,
                157,
                178,
                179,
                159,
                158,
                180,
                158,
                179,
                180,
                160,
                159,
                181,
                159,
                180,
                181,
                161,
                160,
                182,
                160,
                181,
                182,
                162,
                161,
                183,
                161,
                182,
                183,
                163,
                162,
                184,
                162,
                183,
                184,
                164,
                163,
                185,
                163,
                184,
                185,
                165,
                164,
                186,
                164,
                185,
                186,
                166,
                165,
                187,
                165,
                186,
                187,
                167,
                166,
                188,
                166,
                187,
                188,
                169,
                168,
                190,
                168,
                189,
                190,
                170,
                169,
                191,
                169,
                190,
                191,
                171,
                170,
                192,
                170,
                191,
                192,
                172,
                171,
                193,
                171,
                192,
                193,
                173,
                172,
                194,
                172,
                193,
                194,
                174,
                173,
                195,
                173,
                194,
                195,
                175,
                174,
                196,
                174,
                195,
                196,
                176,
                175,
                197,
                175,
                196,
                197,
                177,
                176,
                198,
                176,
                197,
                198,
                178,
                177,
                199,
                177,
                198,
                199,
                179,
                178,
                200,
                178,
                199,
                200,
                180,
                179,
                201,
                179,
                200,
                201,
                181,
                180,
                202,
                180,
                201,
                202,
                182,
                181,
                203,
                181,
                202,
                203,
                183,
                182,
                204,
                182,
                203,
                204,
                184,
                183,
                205,
                183,
                204,
                205,
                185,
                184,
                206,
                184,
                205,
                206,
                186,
                185,
                207,
                185,
                206,
                207,
                187,
                186,
                208,
                186,
                207,
                208,
                188,
                187,
                209,
                187,
                208,
                209,
                190,
                189,
                211,
                191,
                190,
                212,
                192,
                191,
                213,
                193,
                192,
                214,
                194,
                193,
                215,
                195,
                194,
                216,
                196,
                195,
                217,
                197,
                196,
                218,
                198,
                197,
                219,
                199,
                198,
                220,
                200,
                199,
                221,
                201,
                200,
                222,
                202,
                201,
                223,
                203,
                202,
                224,
                204,
                203,
                225,
                205,
                204,
                226,
                206,
                205,
                227,
                207,
                206,
                228,
                208,
                207,
                229,
                209,
                208,
                230
            ]
        }
        const test = {
            pos: new Float32Array(bunny_buffer_geometry.data.attributes.position.array),
            index: new Uint32Array(bunny_buffer_geometry.data.index.array),
        }
        let realIndex = test.index.length;
        const colorOffset = 4 * 4;
        const vertexSize = 4 * 3;
        let verticesArray = new Float32Array([
            // float32x4 position, float32x4 color
            1, -1, 1, 1, 1, 0, 1, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,
            1, -1, -1, 1, 1, 0, 0, 1,
            1, -1, 1, 1, 1, 0, 1, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,

            1, 1, 1, 1, 1, 1, 1, 1,
            1, -1, 1, 1, 1, 0, 1, 1,
            1, -1, -1, 1, 1, 0, 0, 1,
            1, 1, -1, 1, 1, 1, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1,
            1, -1, -1, 1, 1, 0, 0, 1,

            -1, 1, 1, 1, 0, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, -1, 1, 1, 1, 0, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
            -1, 1, 1, 1, 0, 1, 1, 1,
            1, 1, -1, 1, 1, 1, 0, 1,

            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, 1, 1, 1, 0, 1, 1, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,

            1, 1, 1, 1, 1, 1, 1, 1,
            -1, 1, 1, 1, 0, 1, 1, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            1, -1, 1, 1, 1, 0, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1,

            1, -1, -1, 1, 1, 0, 0, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
            1, 1, -1, 1, 1, 1, 0, 1,
            1, -1, -1, 1, 1, 0, 0, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
            //
            // float32x4 position, float32x4 color
            1, -1, 1, 1, 1, 0, 1, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,
            1, -1, -1, 1, 1, 0, 0, 1,
            1, -1, 1, 1, 1, 0, 1, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,

            1, 1, 1, 1, 1, 1, 1, 1,
            1, -1, 1, 1, 1, 0, 1, 1,
            1, -1, -1, 1, 1, 0, 0, 1,
            1, 1, -1, 1, 1, 1, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1,
            1, -1, -1, 1, 1, 0, 0, 1,

            -1, 1, 1, 1, 0, 1, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1,
            1, 1, -1, 1, 1, 1, 0, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
            -1, 1, 1, 1, 0, 1, 1, 1,
            1, 1, -1, 1, 1, 1, 0, 1,

            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, 1, 1, 1, 0, 1, 1, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,

            1, 1, 1, 1, 1, 1, 1, 1,
            -1, 1, 1, 1, 0, 1, 1, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            -1, -1, 1, 1, 0, 0, 1, 1,
            1, -1, 1, 1, 1, 0, 1, 1,
            1, 1, 1, 1, 1, 1, 1, 1,

            1, -1, -1, 1, 1, 0, 0, 1,
            -1, -1, -1, 1, 0, 0, 0, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
            1, 1, -1, 1, 1, 1, 0, 1,
            1, -1, -1, 1, 1, 0, 0, 1,
            -1, 1, -1, 1, 0, 1, 0, 1,
        ]);

        for (let index = 0; index < 36 * 8; index += 8) {
            verticesArray[index] -= 1.2;

        }
        for (let index = 36 * 8; index < 72 * 8; index += 8) {
            verticesArray[index] += 1.2;
            verticesArray[index + 1] += 0.3;
            verticesArray[index + 2] += 0.1;

        }
        let indicesArray = new Uint32Array(72);
        for (let index = 0; index < 72; index++) {
            indicesArray[index] = (index % 36);

        }
        // const data = {
        verticesArray = new Float32Array(test.pos);
        indicesArray = new Uint32Array(test.index);
        console.log(test, indicesArray, realIndex)
        // }
        async function init() {
            const adapter = await navigator.gpu.requestAdapter();
            device = await adapter.requestDevice();

            // Canvas

            const canvas = document.querySelector('canvas');
            const canvasSize = canvas.getBoundingClientRect();
            canvas.width = canvasSize.width;
            canvas.height = canvasSize.height;

            const aspect = Math.abs(canvas.width / canvas.height);
            mat4.perspective(projectionMatrix, (2 * Math.PI) / 5, aspect, 0.01, 1000.0);

            context = canvas.getContext('webgpu');
            const canvasFormat = "bgra8unorm";

            const contextConfiguration = {
                device: device,
                format: canvasFormat,
                alphaMode: 'opaque',
            };
            context.configure(contextConfiguration);

            // Bind Group Layout + Pipeline Layout

            const transformBufferBindGroupLayoutEntry = {
                binding: transformBindingNum, // @group(0) @binding(0)
                visibility: GPUShaderStage.VERTEX,
                buffer: { type: "uniform" },
            };
            const bindGroupLayoutDescriptor = { entries: [transformBufferBindGroupLayoutEntry] };
            const bindGroupLayout = device.createBindGroupLayout(bindGroupLayoutDescriptor);

            const pipelineLayoutDescriptor = { bindGroupLayouts: [bindGroupLayout] };
            const pipelineLayout = device.createPipelineLayout(pipelineLayoutDescriptor);

            // Shader Module

            const shaderModuleDescriptor = { code: shader };
            const shaderModule = device.createShaderModule(shaderModuleDescriptor);

            // Vertex Buffer

            const verticesBufferDescriptor = {
                size: verticesArray.byteLength,
                usage: GPUBufferUsage.VERTEX,
                mappedAtCreation: true,
            };
            verticesBuffer = device.createBuffer(verticesBufferDescriptor)
            const verticesArrayBuffer = verticesBuffer.getMappedRange();

            const verticesWriteArray = new Float32Array(verticesArrayBuffer);
            verticesWriteArray.set(verticesArray);
            verticesBuffer.unmap();
            //
            console.log(indicesArray.byteLength, GPUBufferUsage.INDEX)
            const indicesBufferDescriptor = {
                size: indicesArray.byteLength,
                usage: GPUBufferUsage.INDEX,
                mappedAtCreation: true,

            }
            indicesBuffer = device.createBuffer(indicesBufferDescriptor)
            const indicesArrayBuffer = indicesBuffer.getMappedRange();

            const indicesWriteArray = new Uint32Array(indicesArrayBuffer);
            indicesWriteArray.set(indicesArray);
            indicesBuffer.unmap();
            // Render Pipeline

            // Render Pipeline > Vertex Input
            const positionAttributeState = {
                format: "float32x3",
                offset: 0,
                shaderLocation: positionAttributeNum,  // @attribute(0)
            };
            const colorAttributeState = {
                format: "float32x4",
                offset: colorOffset,
                shaderLocation: colorAttributeNum,  // @attribute(1)
            }
            const vertexBufferState = {
                arrayStride: vertexSize,
                stepMode: "vertex",
                attributes: [positionAttributeState],
            };

            // Render Pipeline > Depth/Stencil State
            const depthFormat = "depth24plus";
            const depthStateDescriptor = {
                format: depthFormat,
                depthWriteEnabled: true,
                depthCompare: "less"
            };

            const colorTargetState = {
                format: "bgra8unorm",
                blend: {
                    alpha: {
                        srcFactor: "src-alpha",
                        dstFactor: "one-minus-src-alpha",
                        operation: "add"
                    },
                    color: {
                        srcFactor: "src-alpha",
                        dstFactor: "one-minus-src-alpha",
                        operation: "add"
                    },
                },
                writeMask: GPUColorWrite.ALL,
            };
            const renderPipelineDescriptor = {
                layout: pipelineLayout,
                vertex: {
                    buffers: [vertexBufferState],
                    module: shaderModule,
                    entryPoint: "vertex_main"
                },
                depthStencil: depthStateDescriptor,
                fragment: {
                    module: shaderModule,
                    entryPoint: "fragment_main",
                    targets: [colorTargetState],
                },
            };
            renderPipeline = device.createRenderPipeline(renderPipelineDescriptor);

            // Render Pass Descriptor

            const colorAttachment = {
                // attachment is acquired in render loop.
                clearValue: { r: 0.5, g: 1.0, b: 1.0, a: 1.0 }, // GPUColor
                loadOp: "clear",
                storeOp: "store",
            };

            // Depth stencil texture

            // GPUExtent3D
            const depthSize = {
                width: canvas.width,
                height: canvas.height,
                depthOrArrayLayers: 1
            };

            const depthTextureDescriptor = {
                size: depthSize,
                arrayLayerCount: 1,
                mipLevelCount: 1,
                sampleCount: 1,
                dimension: "2d",
                format: depthFormat,
                usage: GPUTextureUsage.RENDER_ATTACHMENT
            };

            const depthTexture = device.createTexture(depthTextureDescriptor);

            // GPURenderPassDepthStencilAttachmentDescriptor
            const depthAttachment = {
                view: depthTexture.createView(),
                depthClearValue: 1.0,
                depthLoadOp: "clear",
                depthStoreOp: "store",
                stencilClearValue: 0,
                stencilLoadOp: "load",
                stencilStoreOp: "store",
            };

            renderPassDescriptor = {
                colorAttachments: [colorAttachment],
                depthStencilAttachment: depthAttachment
            };

            // Transform Buffers and Bindings

            const transformSize = 4 * 16;
            const transformBufferDescriptor = {
                size: transformSize,
                usage: GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST,
            };
            transformBuffer = device.createBuffer(transformBufferDescriptor)

            const transformBufferBinding = {
                buffer: transformBuffer,
                offset: 0,
                size: transformSize
            };
            const transformBufferBindGroupEntry = {
                binding: transformBindingNum,
                resource: transformBufferBinding
            };
            const bindGroupDescriptor = {
                layout: bindGroupLayout,
                entries: [transformBufferBindGroupEntry]
            };
            bindGroup = device.createBindGroup(bindGroupDescriptor);

            cubeDraw = new Uint32Array(5);
            cubeDraw[0] = realIndex; // vertex_count;The number of vertices to draw.
            cubeDraw[1] = 1; // instance_count; The number of instances to draw.
            cubeDraw[2] = 0; // base_index; The base index within the index buffer.
            cubeDraw[3] = 0; // vertex_offset; The value added to the vertex index before indexing into the vertex buffer.
            cubeDraw[4] = 0; // base_instance; The instance ID of the first instance to draw. Has to be 0, unless Features::INDIRECT_FIRST_INSTANCE is enabled.
            console.log(cubeDraw.byteLength)
            cubeBuffer = device.createBuffer({
                size: cubeDraw.byteLength,
                usage: GPUBufferUsage.INDIRECT | GPUBufferUsage.COPY_DST
            });
            device.queue.writeBuffer(cubeBuffer, 0, cubeDraw);
            gpu = new WebGPU(canvas, context, adapter, device, "bgra8unorm", "opaque");
            renderer = new ClusterRenderer(gpu);
            render();
        }

        function render() {
            updateTransformArray();
            renderer.setCurrentPass(renderPassDescriptor);
            renderer.render();
            // gpu.begin();
            // renderer.setEncoderByGPU(gpu);
            // renderer.setCurrentPass(renderPassDescriptor);
            // renderer.createView(gpu.getContextView());
            // renderer.beginCurrentPass();
            // renderer.setPipeline(renderPipeline);
            // renderer.setVertexBuffer(0, verticesBuffer);
            // renderer.setIndexBuffer(indicesBuffer, 'uint16');
            // renderer.setBindGroup(bindGroupIndex, bindGroup);
            // renderer.drawIndexedIndirect(cubeBuffer, 0);
            // renderer.endCurrentPass();
            // gpu.end();
            requestAnimationFrame(render);
        }

        function updateTransformArray() {
            const viewMatrix = mat4.create();
            mat4.translate(viewMatrix, viewMatrix, vec3.fromValues(0, 0, -1.0));
            const now = Date.now() / 1000;
            mat4.rotate(viewMatrix, viewMatrix, 1, vec3.fromValues(Math.sin(now), Math.cos(now), 0));
            const modelViewProjectionMatrix = mat4.create();
            mat4.multiply(modelViewProjectionMatrix, projectionMatrix, viewMatrix);
            device.queue.writeBuffer(transformBuffer, 0, modelViewProjectionMatrix);
        }

        window.addEventListener("load", init);

        class WebGPU {
            constructor(canvas, context, adapter, device, context_format, context_alphaMode) {
                this.canvas = canvas;
                this.context = context;
                this.adapter = adapter;
                this.device = device;
                // init
                context.configure({
                    device: device,
                    format: context_format,
                    alphaMode: context_alphaMode,

                });
            }
            begin() {
                this.commandEncoder = this.device.createCommandEncoder();
            }
            end() {
                this.device.queue.submit([this.commandEncoder.finish()]);
            }
            getContextView() {
                return this.context.getCurrentTexture().createView();
            }
        }

        class ClusterRenderer {
            constructor(gpu) {
                this.gpu = gpu;
            }
            setEncoderByGPU(gpu) {
                this.commandEncoder = gpu.commandEncoder;
            }
            setEncoder(commandEncoder) {
                this.commandEncoder = commandEncoder;
            }
            setCurrentPass(pass) {
                this.currentPass = pass;
            }
            createView(view) {
                this.currentPass.colorAttachments[0].view = view;
            }
            beginCurrentPass() {
                this.currentPassEncoder = this.commandEncoder.beginRenderPass(this.currentPass);
            }
            beginPass(pass) { // pass == renderPassDescriptor
                this.currentPassEncoder = this.commandEncoder.beginRenderPass(pass);
            }
            endPass(pass) {
                pass.end();
            }
            endCurrentPass() {
                this.currentPassEncoder.end();
            }
            setPipeline(pipeline) {
                this.currentPassEncoder.setPipeline(pipeline);
            }

            setBindGroup(groupIndex, group) {
                this.currentPassEncoder.setBindGroup(groupIndex, group);
            }

            setVertexBuffer(slot, buffer, offset = 0) {
                this.currentPassEncoder.setVertexBuffer(slot, buffer, offset);
            }

            setIndexBuffer(buffer, indexFormat, offset = 0) {
                this.currentPassEncoder.setIndexBuffer(buffer, indexFormat, offset);
            }


            drawArray(indexCount, instanceCount, firstIndex, baseVertex, firstInstance) {
                this.currentPassEncoder.draw(indexCount, instanceCount, firstIndex, baseVertex, firstInstance)
            }

            drawIndexed(indexCount, instanceCount, firstIndex, baseVertex, firstInstance) {
                this.currentPassEncoder.drawIndexed(indexCount, instanceCount, firstIndex, baseVertex, firstInstance);
            }

            drawIndexedIndirect(buffer, offset = 0) {
                this.currentPassEncoder.drawIndexedIndirect(buffer, offset);
            }
            render() {
                const gpu = this.gpu;
                gpu.begin();
                this.setEncoderByGPU(gpu);
                this.createView(gpu.getContextView());
                this.beginCurrentPass();
                this.setPipeline(renderPipeline);
                // these things should be generated by compute shader.
                const combinedVBuffer = verticesBuffer;
                const combinedIBuffer = indicesBuffer;
                const indirectBufferSingle = cubeBuffer;
                this.setVertexBuffer(0, combinedVBuffer);
                this.setIndexBuffer(combinedIBuffer, 'uint32');
                this.setBindGroup(bindGroupIndex, bindGroup);
                // this should be a for loop  maybe it support multi in the future.
                this.drawIndexedIndirect(cubeBuffer, 0);
                this.endCurrentPass();
                gpu.end();
            }
        }
    </script>
</body>

</html>